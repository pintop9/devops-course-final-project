pipeline {
    agent any

    environment {
        GIT_REPO_URL = 'https://github.com/pintop9/devops-course-final-project.git'
        GIT_BRANCH = 'main'
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials-id')
        DOCKERHUB_REPO = 'pintop9'
    }

    stages {
        stage('Pull from GitHub') {
            steps {
                script {
                    try {
                        git branch: GIT_BRANCH, url: GIT_REPO_URL
                    } catch (Exception e) {
                        echo "Failed to pull from GitHub: ${e.message}"
                        error "Stopping the build."
                    }
                }
            }
        }

        stage('Test Docker Login') {
            steps {
                script {
                    sh '''
                    echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    try {
                        docker-compose build
                        currentBuild.result = 'SUCCESS'
                    } catch (Exception e) {
                        echo "Failed to build Docker images: ${e}"
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }

        stage('Running Tests') {
            steps {
                script {
                    try {
                        sh '''
                        python3 -m venv env
                        . backend/env/bin/activate
                        mkdir -p backend/test-reports
                        pytest --html=backend/test-reports/report.html
                        '''
                        currentBuild.result = 'SUCCESS'
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                    }
                }
            }
        }

        stage('Push Docker Images') {
            when {
                expression { currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    try {
                        sh 'docker-compose push'
                        echo "Docker images pushed to Docker Hub."
                        currentBuild.result = 'SUCCESS'
                    } catch (Exception e) {
                        echo "Failed to push Docker images: ${e}"
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }

        stage('Publish Report') {
            when {
                expression { currentBuild.result == 'FAILURE' }
            }
            steps {
                publishHTML(target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'backend/test-reports',
                    reportFiles: 'report.html',
                    reportName: 'Django Report',
                    reportTitles: 'The Tests Report'
                ])
            }
        }

        stage('Notify the Developers') {
            steps {
                script {
                    if (currentBuild.result == 'FAILURE') {
                        emailext(
                            body: """
                                <p>The build status is ${currentBuild.currentResult}, on project ${env.JOB_NAME}.</p>
                                <p>Find the test report at this URL: ${BUILD_URL}Django_20Report/</p>
                            """,
                            subject: "Failed build/job ${env.JOB_NAME} - ${env.BUILD_NUMBER} from Jenkins",
                            to: 'bitradingu@gmail.com',
                            mimeType: 'text/html'
                        )
                    } else if (currentBuild.result == 'SUCCESS') {
                        echo "Build succeeded. Notify developers."
                        emailext(
                            body: """
                                <p>The build was successful for project ${env.JOB_NAME}.</p>
                            """,
                            subject: "Successful build/job ${env.JOB_NAME} - ${env.BUILD_NUMBER} from Jenkins",
                            to: 'bitradingu@gmail.com',
                            mimeType: 'text/html'
                        )
                    }
                }
            }
        }

        stage('Deploy Containers') {
            when {
                expression { currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    sh '''
                    docker-compose down --remove-orphans || true
                    docker-compose up -d
                    '''
                }
            }
        }
    }
}
